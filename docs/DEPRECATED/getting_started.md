# Getting started


## 0. Requirements

Python >=3.7

anaconda/miniconda >=4.3

MongoDB >=4.0.0

## 1. Install MongoDB

Get MongoDB (community edition) and set it up following their documentation.

https://www.mongodb.com/download-center/community

The following accounts are a suggested way to set up the database.

You'll need an account with the role `userAdminAnyDatabase` to manage other accounts.

Then create a user with the `dbAdmin` role for the databases `bifrost_species` and `bifrost_prod`.
This will be the account that will setup the `bifrost_species` database and the indexes for both dbs.

Switch to the `bifrost_prod` database and create another user with `read` role for `bifrost_species` and `readWrite` for `bifrost_prod`.
This user will be the one bifrost will use. The `bifrost_species` account doesn't need to be updated on a routine basis.

## 2. Create the species database

The system relies on a species collection containing species-specific information used for
QC testing.

2.1 Create a database in MongoDB `bifrost_species`.
2.2 Import the file "setup/species.json" in the newly created database.
The command will look something like this (use the user with `dbAdmin` role):

```bash
mongoimport --host <host> --port <port> --username <dbuser> --authenticationDatabase admin --db bifrost_species --collection species
```

You can find more information about the mongoimport command here: https://docs.mongodb.com/manual/reference/program/mongoimport/

Here is an example of an entry in the species database:

```
{
    "_id" : ___, # mongoDB autogenerated id
    "organism" : "E. coli",
    "group" : "Escherichia", # Can be used as an alternative name
    "mlst_species" : "/path_to_db/ariba/mlst/Escherichia_coli_1/ref_db/", # Used by the mlst component
    "ncbi_species" : "Escherichia coli", # Matches kraken output.
    "min_length" : 4500000, #min and max genome size to pass QC
    "max_length" : 5800000
}
```

Note: We are in the process of simplifying the species DB

After this step you should have a mongodb instance running, a user and a species collection with the species you expect to find in the samples.

## 3. Add the indexes to the database

Add the indexes in setup/DBIndexes.js to the bifrost_prod database.

## 4. Download and install bifrost

```
git clone git@github.com:ssi-dk/bifrost.git
cd bifrost/setup
bash install.sh
```

## 5. Save the mongo db keys

Create a text file containing the mongodb uri for the serumqc_prod database with the "read" user credentials.

`mongodb://username:password@host:port/bifrost_prod`

Save this file in the `<bifrost repo>/resources` directory as `keys.txt`


## 6. Adjusting config

Copy `<bifrost repo>/setup/default_config.yaml` to `<bifrost repo>/config.yaml` and adjust the parameters.

## 7. Install the required resources

Go to the `setup` directory and run `bash install.sh` or execute the commands one by one.
The script will set up a folder named bifrost_resources with the minikraken database
required for the whats_my_species component.

The script will also install the conda environment.


## Running bifrost:

(more info in [User guide](user_guide.md))

Activate conda environment `bifrost`:

```bash
source activate bifrost
```

Create output directory, and move into it, though we [recommend this structure](file_structure.md):

```bash
mkdir run_name # Run name will be taken from the directory name or it can be set through config
cd run_name
```

Link the demultiplexed (fastq.gz) samples folder as samples (by default):

```bash
ln -s path/to/run samples
```

Copy this directory in src directory:

```bash
cp -r <path to your bifrost directory> src
```

Run snakemake to generate the run command and the folder structures.

Set the [components](components.md) you want to run (component names are the filenames in /components dir). With the basic install you'll be able to run min_read_check, whats_my_species, assemblatron, qcquickie and ssi_stamper. Other components require additional set-up. In the future components will have a more streamlined install process.

Then start the program running:

```
snakemake -s src/bifrost.smk
```

You can change any option in config.yaml using the `--config` argument. Here is an example with some useful ones:

```
--config components=min_read_check,whats_my_species,assemblatron,ssi_stamper
```

For more info on each parameter, check the sample config file.

